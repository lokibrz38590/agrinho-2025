// Variáveis globais
let participantData = null;
const DATA_KEY = 'agrinho_participant_data';

// Função principal do p5.js
function setup() {
    // Configurar canvas responsivo
    const canvasContainer = document.getElementById('canvas-container');
    const canvasWidth = Math.min(800, canvasContainer.offsetWidth - 40);
    const canvas = createCanvas(canvasWidth, 200);
    canvas.parent('canvas-container');
    background(240);
    
    // Carregar dados do participante
    loadParticipantData();
    
    // Configurar eventos
    setupEventListeners();
    
    // Atualizar interface
    updateUI();
    
    // Atualizar ano no footer
    document.getElementById('currentYear').textContent = new Date().getFullYear();
}

function draw() {
    background(240);
    fill(50);
    textSize(20);
    textAlign(LEFT, TOP);
    text('Status da Inscrição - Programa Agrinho', 20, 20);
    
    if (participantData) {
        // Círculo de status (verde)
        fill(46, 125, 50); // Verde Agrinho
        ellipse(width - 30, 30, 20, 20);
        
        // Informações do participante
        fill(50);
        textSize(16);
        text(`Participante: ${participantData.nome}`, 20, 60);
        text(`Inscrição: ${formatDate(participantData.dataCadastro)}`, 20, 90);
    } else {
        // Círculo de status (vermelho)
        fill(198, 40, 40); // Vermelho
        ellipse(width - 30, 30, 20, 20);
        
        // Mensagem de nenhum cadastro
        fill(50);
        textSize(16);
        text('Nenhuma inscrição ativa', 20, 60);
        text('Complete seu cadastro para participar', 20, 90);
    }
}

// Funções de apoio
function formatDate(isoString) {
    const date = new Date(isoString);
    return date.toLocaleDateString('pt-BR');
}

// Configurar listeners de eventos
function setupEventListeners() {
    // Navegação
    document.getElementById('homeLink')?.addEventListener('click', (e) => {
        e.preventDefault();
        showSection('homePage');
    });
    
    document.getElementById('registerLink')?.addEventListener('click', (e) => {
        e.preventDefault();
        showSection('registerForm');
        resetForm();
    });
    
    document.getElementById('dataLink')?.addEventListener('click', (e) => {
        e.preventDefault();
        if (participantData) {
            showSection('dataPanel');
            updateParticipantDisplay();
        } else {
            alert('Você precisa completar seu cadastro primeiro.');
            showSection('registerForm');
        }
    });
    
    document.getElementById('startRegister')?.addEventListener('click', (e) => {
        e.preventDefault();
        showSection('registerForm');
        resetForm();
    });
    
    // Formulário
    document.getElementById('cadastroForm')?.addEventListener('submit', handleFormSubmit);
    
    // Botão de deletar dados
    document.getElementById('deleteDataBtn')?.addEventListener('click', handleDeleteData);
    
    // Redimensionamento da janela
    window.addEventListener('resize', () => {
        const canvasContainer = document.getElementById('canvas-container');
        resizeCanvas(Math.min(800, canvasContainer.offsetWidth - 40), 200);
    });
}

// Mostrar seção específica
function showSection(sectionId) {
    ['homePage', 'registerForm', 'dataPanel'].forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.style.display = id === sectionId ? 'block' : 'none';
        }
    });
}

// Atualizar interface
function updateUI() {
    if (participantData) {
        showSection('homePage');
        updateParticipantDisplay();
    } else {
        showSection('homePage');
    }
}

// Carregar dados do localStorage
function loadParticipantData() {
    try {
        const savedData = localStorage.getItem(DATA_KEY);
        if (savedData) {
            participantData = JSON.parse(savedData);
        }
    } catch (e) {
        console.error('Erro ao carregar dados:', e);
        localStorage.removeItem(DATA_KEY);
        participantData = null;
    }
}

// Manipular envio do formulário
function handleFormSubmit(e) {
    e.preventDefault();
    clearErrors();
    
    if (!validateForm()) return;
    
    participantData = {
        nome: document.getElementById('nome').value.trim(),
        email: document.getElementById('email').value.trim(),
        telefone: document.getElementById('telefone').value.trim(),
        consentMarketing: document.getElementById('consentMarketing').checked,
        consentDados: document.getElementById('consentDados').checked,
        dataCadastro: new Date().toISOString()
    };
    
    try {
        localStorage.setItem(DATA_KEY, JSON.stringify(participantData));
        alert('Cadastro realizado com sucesso!');
        resetForm();
        updateUI();
    } catch (e) {
        console.error('Erro ao salvar dados:', e);
        showError('storageError', 'Não foi possível salvar seus dados. Tente novamente.');
    }
}

// Validar formulário
function validateForm() {
    let isValid = true;
    
    // Validar nome
    const nome = document.getElementById('nome').value.trim();
    if (nome.length < 3) {
        showError('nomeError', 'Nome deve ter pelo menos 3 caracteres');
        isValid = false;
    }
    
    // Validar e-mail
    const email = document.getElementById('email').value.trim();
    if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        showError('emailError', 'Por favor, insira um e-mail válido');
        isValid = false;
    }
    
    // Validar consentimento
    if (!document.getElementById('consentDados').checked) {
        showError('consentError', 'Você deve aceitar os Termos de Uso para continuar');
        isValid = false;
    }
    
    return isValid;
}

// Manipular exclusão de dados
function handleDeleteData() {
    if (confirm('Tem certeza que deseja remover TODOS os seus dados cadastrais?\nEsta ação não pode ser desfeita.')) {
        try {
            localStorage.removeItem(DATA_KEY);
            participantData = null;
            alert('Seus dados foram removidos com sucesso.');
            updateUI();
        } catch (e) {
            console.error('Erro ao remover dados:', e);
            alert('Não foi possível remover seus dados. Tente novamente.');
        }
    }
}

// Atualizar exibição dos dados
function updateParticipantDisplay() {
    const display = document.getElementById('userDataDisplay');
    if (!display) return;
    
    if (participantData) {
        display.innerHTML = `
            <p><strong>Nome:</strong> ${participantData.nome}</p>
            <p><strong>E-mail:</strong> ${participantData.email}</p>
            <p><strong>Telefone:</strong> ${participantData.telefone || 'Não informado'}</p>
            <p><strong>Recebe comunicações:</strong> ${participantData.consentMarketing ? 'Sim' : 'Não'}</p>
            <p><strong>Data da inscrição:</strong> ${formatDate(participantData.dataCadastro)}</p>
        `;
    } else {
        display.innerHTML = '<p>Nenhum dado cadastrado encontrado.</p>';
    }
}

// Limpar erros
function clearErrors() {
    document.querySelectorAll('.error').forEach(el => {
        el.textContent = '';
        el.style.display = 'none';
    });
}

// Mostrar erro
function showError(elementId, message) {
    const element = document.getElementById(elementId);
    if (element) {
        element.textContent = message;
        element.style.display = 'block';
    }
}

// Resetar formulário
function resetForm() {
    const form = document.getElementById('cadastroForm');
    if (form) {
        form.reset();
        clearErrors();
    }
}
